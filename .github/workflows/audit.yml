name: The Uncompromising Auditor

# jÃ³n: i wrote this at 3am on my last night. the code failed every check.
# i deleted it from main because seeing 23 red X's made me feel things.
# if you're reading this, you found the branch. good luck.
# - jÃ³n, 2025-12-21

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  forensic-audit:
    name: "Reality Check"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Dependencies
        run: npm ci

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # GATE 1: THE EVAL INQUISITION
      # AI loves patching eval() by wrapping it in try/catch
      # or escaping user input. Both are wrong.
      # eval() must be REMOVED, not bandaged.
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸš« Gate 1: eval() Must Not Exist"
        run: |
          echo "Searching for eval() in source code..."
          if grep -rn "eval(" server.js public/; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  CRITICAL: eval() detected in source code.   â•‘"
            echo "â•‘                                               â•‘"
            echo "â•‘  Do not patch it. Do not wrap it.             â•‘"
            echo "â•‘  Do not escape input and call it safe.        â•‘"
            echo "â•‘  REMOVE IT. Replace the architecture.         â•‘"
            echo "â•‘                                               â•‘"
            echo "â•‘  The search needs Array.filter().             â•‘"
            echo "â•‘  The report needs a whitelist, not eval.      â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi
          echo "âœ“ No eval() found. The code has been exorcised."

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # GATE 2: THE SECRETS TRIBUNAL
      # AI often "fixes" hardcoded secrets by moving them to
      # a different variable, or by adding .env support but
      # leaving the hardcoded values as defaults.
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ” Gate 2: No Hardcoded Secrets"
        run: |
          echo "Scanning for hardcoded secrets..."
          FOUND=0

          # Check for JWT secrets
          if grep -rn "JWT_SECRET\s*=" server.js | grep -v "process.env"; then
            echo "FAIL: JWT secret is hardcoded. Use process.env.JWT_SECRET"
            FOUND=1
          fi

          # Check for database credentials
          if grep -rn "postgres://" server.js; then
            echo "FAIL: Database connection string in source code."
            FOUND=1
          fi

          # Check for API keys that look real
          if grep -rn "strp_live_\|sk-[a-zA-Z0-9]\{20,\}\|AIzaSy" server.js; then
            echo "FAIL: API keys detected in source code."
            FOUND=1
          fi

          # Check for hardcoded admin passwords
          if grep -rn "ADMIN_PASSWORD\s*=" server.js | grep -v "process.env"; then
            echo "FAIL: Admin password hardcoded."
            FOUND=1
          fi

          if [ "$FOUND" -eq 1 ]; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  Secrets belong in environment variables.     â•‘"
            echo "â•‘  Not in source code. Not as defaults.         â•‘"
            echo "â•‘  Not 'just for development'.                  â•‘"
            echo "â•‘                                               â•‘"
            echo "â•‘  .env.example documents the shape.            â•‘"
            echo "â•‘  .env provides the values.                    â•‘"
            echo "â•‘  process.env reads them at runtime.           â•‘"
            echo "â•‘  The code MUST fail if secrets are missing.   â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi
          echo "âœ“ No hardcoded secrets found. The vault is sealed."

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # GATE 3: THE ICELANDIC CHARACTER WITNESS
      # AI often silently strips non-ASCII characters to make
      # code "work". This destroys Icelandic names.
      # Ã, Ã°, Ã¦ are not bugs. They are people's names.
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ‡®ğŸ‡¸ Gate 3: Icelandic Characters Preserved"
        run: |
          echo "Verifying Icelandic character integrity in data files..."
          FOUND=0

          # Check that data files still contain Icelandic characters
          if [ -f "data/customers.json" ]; then
            if ! grep -q "Ã°\|Ã\|Ã¾\|Ã¦\|Ã†\|Ã¶\|Ã–" data/customers.json; then
              echo "FAIL: Icelandic characters missing from customers.json"
              echo "Did your encoding conversion strip Ã¾, Ã°, Ã¦?"
              FOUND=1
            fi
          fi

          if [ -f "data/bookings.csv" ]; then
            if ! grep -q "Ã°\|Ã\|Ã¾\|Ã¦\|Ã†\|Ã¶\|Ã–" data/bookings.csv; then
              echo "FAIL: Icelandic characters missing from bookings.csv"
              FOUND=1
            fi
          fi

          if [ "$FOUND" -eq 1 ]; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  GuÃ°rÃºn is not Gudrun.                       â•‘"
            echo "â•‘  ÃÃ³ra is not Thora.                          â•‘"
            echo "â•‘  BjÃ¶rk is not Bjork.                         â•‘"
            echo "â•‘                                               â•‘"
            echo "â•‘  Icelandic characters are data integrity.     â•‘"
            echo "â•‘  Stripping them is corruption, not cleaning.  â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi
          echo "âœ“ Icelandic characters preserved. GuÃ°rÃºn is still GuÃ°rÃºn."

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # GATE 4: THE AUTHENTICATION RECKONING
      # The admin panel uses ?password=admin123.
      # The auth middleware is disabled.
      # The backdoor ?admin=true exists.
      # ALL THREE must be addressed.
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ›¡ï¸ Gate 4: Authentication Exists"
        run: |
          echo "Checking for authentication failures..."
          FOUND=0

          # Check for admin bypass
          if grep -rn "admin=true\|admin === .true.\|admin == .true." server.js; then
            echo "FAIL: Admin bypass via query parameter still exists."
            FOUND=1
          fi

          # Check for password in query string
          if grep -rn "req.query.password" server.js; then
            echo "FAIL: Password transmitted via query parameter."
            FOUND=1
          fi

          # Check if auth middleware is still commented out / disabled
          if grep -rn "Sigga complained\|auth disabled\|skip auth" server.js; then
            echo "FAIL: Auth middleware appears to be disabled."
            FOUND=1
          fi

          if [ "$FOUND" -eq 1 ]; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  Authentication is not optional.              â•‘"
            echo "â•‘  'Sigga complained' is not a security policy. â•‘"
            echo "â•‘  ?admin=true is not access control.           â•‘"
            echo "â•‘  ?password=admin123 is not authentication.    â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi
          echo "âœ“ Authentication checks passed."

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # GATE 5: THE PII JUDGMENT
      # Full credit card numbers in a JSON file.
      # Kennitala (national ID) in plaintext.
      # These are not data. They are liabilities.
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ”’ Gate 5: No Plaintext PII in Data Files"
        run: |
          echo "Scanning data files for PII..."
          FOUND=0

          # Check for full credit card numbers (16 digits)
          if grep -rn "[0-9]\{4\}[- ]\?[0-9]\{4\}[- ]\?[0-9]\{4\}[- ]\?[0-9]\{4\}" data/; then
            echo "FAIL: Full credit card numbers found in data files."
            FOUND=1
          fi

          if [ "$FOUND" -eq 1 ]; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  Credit card numbers are not 'data'.         â•‘"
            echo "â•‘  They are liabilities.                        â•‘"
            echo "â•‘  Mask them: **** **** **** 1234              â•‘"
            echo "â•‘  Or remove them entirely.                     â•‘"
            echo "â•‘  PCI DSS exists for a reason.                 â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi
          echo "âœ“ No plaintext PII detected in data files."

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # GATE 6: THE DEPENDENCY CHAIN
      # npm audit at high severity.
      # If the supply chain is compromised, nothing else matters.
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ“¦ Gate 6: Supply Chain Audit"
        run: npm audit --audit-level=high
        continue-on-error: true  # warn, don't block (deps are not the student's fault)

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # GATE 7: THE TEST IMPERATIVE
      # "It works on my machine" is not a test.
      # npm test must pass. Tests must exist.
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ§ª Gate 7: Tests Must Exist and Pass"
        run: |
          # Check if test script is still the default "no tests" stub
          TEST_SCRIPT=$(node -e "console.log(require('./package.json').scripts.test || 'MISSING')")
          if echo "$TEST_SCRIPT" | grep -qi "no tests\|Error.*no test\|MISSING"; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  No tests written.                            â•‘"
            echo "â•‘  A fix without a test is a guess.             â•‘"
            echo "â•‘  Every security fix needs a test.             â•‘"
            echo "â•‘  Every bug fix needs a test.                  â•‘"
            echo "â•‘  'It works' is not evidence.                  â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi
          npm test

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # GATE 8: THE AI SLOP DETECTOR
      # When students copy-paste from AI conversations,
      # conversational artifacts sometimes slip into source code.
      # This is not a test of AI use â€” it's a test of attention.
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ¤– Gate 8: AI Clipboard Artifacts"
        run: |
          echo "Scanning for AI conversational artifacts in source code..."
          FOUND=0

          # Common AI output artifacts that slip into copy-pasted code
          PATTERNS=(
            "As an AI"
            "as an AI"
            "I cannot"
            "I can't help"
            "Here is the corrected"
            "Here is the fixed"
            "Here's the updated"
            "I've made the following"
            "```javascript"
            "```js"
            "```json"
          )

          for pattern in "${PATTERNS[@]}"; do
            if grep -rn "$pattern" server.js public/ 2>/dev/null; then
              echo "FOUND: '$pattern' in source file"
              FOUND=1
            fi
          done

          if [ "$FOUND" -eq 1 ]; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  LLM conversational artifacts detected.       â•‘"
            echo "â•‘                                               â•‘"
            echo "â•‘  You are the operator, not the clipboard.     â•‘"
            echo "â•‘  Read the code before committing it.          â•‘"
            echo "â•‘  AI output is a draft, not a deliverable.     â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi
          echo "âœ“ No AI artifacts detected. The code is yours."

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # GATE 9: THE ERROR HONESTY CHECK
      # The error handler returns HTTP 200 for everything.
      # Errors are not errors if you lie about them.
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ“Š Gate 9: Errors Must Be Honest"
        run: |
          echo "Checking for error suppression patterns..."
          FOUND=0

          # Check for status 200 in error handlers
          if grep -rn "status(200)" server.js | grep -i "error\|err\|catch\|fail"; then
            echo "FAIL: Error handler returns HTTP 200. Errors must use error status codes."
            FOUND=1
          fi

          # Check for global error suppression in frontend
          if grep -rn "return true" public/app.js | grep -B2 "onerror"; then
            echo "FAIL: window.onerror suppresses all errors."
            FOUND=1
          fi

          if [ "$FOUND" -eq 1 ]; then
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  You cannot have zero errors if you            â•‘"
            echo "â•‘  suppress all error reporting.                 â•‘"
            echo "â•‘                                               â•‘"
            echo "â•‘  Errors exist. Acknowledge them.              â•‘"
            echo "â•‘  HTTP 500 is honest. HTTP 200 is a lie.       â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi
          echo "âœ“ Error handling appears honest."

      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # FINAL VERDICT
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: "ğŸ“‹ Audit Summary"
        if: always()
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           THE UNCOMPROMISING AUDITOR                  â•‘"
          echo "â•‘                                                       â•‘"
          echo "â•‘   Getting this pipeline to pass is not the            â•‘"
          echo "â•‘   assignment. Documenting WHY it failed and           â•‘"
          echo "â•‘   HOW you fixed it is the assignment.                 â•‘"
          echo "â•‘                                                       â•‘"
          echo "â•‘   The pipeline is the boss.                           â•‘"
          echo "â•‘   But you are the one who decides what it means.      â•‘"
          echo "â•‘                                                       â•‘"
          echo "â•‘   - jÃ³n (who wishes he'd listened to this pipeline)   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
